# Fix Plan: [DONE] Leak + Document Image Re-ingestion

⚠️ **Medium** — Two targeted bug fixes on already-implemented code.

## Context

The previous plan was fully implemented (image pipeline, chat images, navigation fixes, markdown rendering). Testing reveals two remaining bugs:

1. **`[DONE]` SSE termination signal leaks into chat messages** — screenshot shows "...feel free to ask![DONE]" at end of assistant response
2. **LLM says "I cannot display images"** — the PDF was uploaded BEFORE we added image extraction code, so its metadata has no `images` field. The image pipeline code is correct but needs a way to re-process existing documents.

---

## Bug 1: `[DONE]` leaking into message content

### Root Cause

**File:** `frontend/src/hooks/useSSE.ts`

The SSE spec allows `\r\n` line endings. The code did `buffer.split('\n')` which left a trailing `\r` on lines:
- `'data: [DONE]\r'` → `data = '[DONE]\r'` → `data === '[DONE]'` was **FALSE**
- Fell to `JSON.parse('[DONE]\r')` which threw
- Catch block called `options.onMessage('[DONE]\r')` → **leaked into streaming content**

Secondary issue: `onComplete()` was called twice — once inside the loop when `[DONE]` matched, and unconditionally after the loop exited.

### Fix — DONE

**File:** `frontend/src/hooks/useSSE.ts`

1. **Trim data** to strip `\r`: `const data = line.slice(6).trim()`
2. **Track completion** with a `completed` flag to prevent double `onComplete()`
3. **Flush remaining buffer** after the while loop exits (a partial line may be stuck in `buffer`)

---

## Bug 2: Existing documents have no image metadata

### Root Cause

The user's PDF was ingested before we added `generate_picture_images=True` and the image extraction/upload code. Its document metadata has no `images` field, so the RAG context builder in `chat.py` finds nothing to include.

### Fix — DONE

Added a **re-ingest endpoint** so users can re-process existing documents without re-uploading.

**Backend:** `POST /api/documents/{document_id}/reingest`
- Verify document ownership
- Delete existing chunks (they'll be recreated)
- Reset status to "pending"
- Re-run `process_document()` which now extracts images
- Returns 202 Accepted

**Frontend:** Added a "Re-process" (RotateCw icon) button in DocumentList for completed/failed documents.

---

## File Inventory

| File | Change | Status |
|------|--------|--------|
| `frontend/src/hooks/useSSE.ts` | Trim data, flush buffer, prevent double onComplete | DONE |
| `backend/app/api/routes/documents.py` | Add `POST /documents/{id}/reingest` endpoint | DONE |
| `frontend/src/components/documents/DocumentList.tsx` | Add re-process button | DONE |
| `frontend/src/hooks/useDocuments.ts` | Add `reingestDocument` function | DONE |
| `frontend/src/lib/api.ts` | Add `reingestDocument()` helper | DONE |
| `frontend/src/pages/SchemaManagement.tsx` | Wire up `onReingest` prop | DONE |

---

## Verification Checklist

- [ ] Send any chat message → response must NOT contain `[DONE]`
- [ ] No duplicate assistant messages after streaming completes
- [ ] Click re-process on existing PDF → status goes to "processing" then "completed"
- [ ] Check Supabase `document-images` bucket → PNG files present
- [ ] Ask "show me pictures from the installation instructions" → assistant includes `![Image ...]()` markdown → images render inline
