# 8. Document Images in Chat Responses

## Status: ✅ DONE — Working, needs re-ingestion for higher quality

## What Was Implemented

Full end-to-end pipeline for showing document images in chat responses:

1. **AuthenticatedImage component** — fetches `/api/` images with Bearer token via blob URLs, click-to-zoom lightbox with Escape/backdrop close
2. **SSE image events** — backend sends `{"images": [...]}` SSE event with structured image metadata before streaming content
3. **LLM relevance filtering** — quick non-streaming LLM call filters images to only those relevant to the user's question
4. **Persisted attachments** — image refs saved as `document_image` attachments on assistant messages for reload persistence
5. **Docling 2x resolution** — `images_scale=2.0` in PdfPipelineOptions for higher quality extraction

## Files Changed

| File | What Changed |
|------|-------------|
| `frontend/src/components/chat/AuthenticatedImage.tsx` | **NEW** — Fetches API images with auth headers via blob URLs, shimmer loading, error state, click-to-zoom lightbox (Escape/backdrop close), `min-h-[50vh]` zoom for small images |
| `frontend/src/components/chat/MessageList.tsx` | Replaced all raw `<img>` with `AuthenticatedImage`, added `DocumentImages` gallery component (label + flex-wrap grid of 160x160 thumbnails), renders for both streaming and historical messages |
| `frontend/src/hooks/useSSE.ts` | Added `SSEImageRef` interface export, `onImages` callback in `UseSSEOptions`, parses `parsed.images` in SSE handler |
| `frontend/src/hooks/useChat.ts` | Added `streamingImages` state + `streamingImagesRef` (captures ref before clearing to avoid React timing bug), wires `onImages`, includes `document_image` attachments on local assistant message in `onComplete` |
| `frontend/src/pages/ChatView.tsx` | Passes `streamingImages` from `useChat()` to `MessageList` |
| `frontend/src/types/chat.ts` | Made `storage_path` optional on `Attachment`, added optional `alt` field |
| `backend/app/api/routes/chat.py` | Collects all image refs as structured dicts, LLM relevance filter before streaming, emits `images` SSE event, persists as `document_image` attachments, system prompt tells LLM NOT to reproduce markdown image syntax |
| `backend/app/services/ingestion_service.py` | Fixed `ImageRef.pil_image` (was calling `.save()` on Docling `ImageRef` instead of its `.pil_image` property), set `images_scale=2.0` for higher resolution extraction |

## Key Architecture Decisions

### Auth problem solved
Browser `<img>` tags can't send Authorization headers. `AuthenticatedImage` solves this by fetching via `fetch()` with Bearer token, creating blob URLs, and rendering those.

### React timing bug fix
In `useChat.ts` `onComplete`, the `setStreamingContent` updater runs lazily during render, but `streamingImagesRef.current = []` runs immediately. Fix: capture ref into local variable before the `setState` call.

### LLM image filtering
System prompt used to ask LLM to reproduce markdown image syntax — unreliable. Now:
- All images collected from retrieved docs
- Quick `chat_completion` call asks LLM to pick relevant image indices
- Only filtered images sent to frontend + persisted
- System prompt tells LLM to reference images textually, not reproduce URLs

## Known Issues / Future Work

- **Re-ingestion required** for 2x quality: existing documents still have 1x images in Supabase storage. Use the reingest button or re-upload to get higher quality.
- **Image descriptions are generic** (e.g., "Image 0 from doc.pdf"). Could improve by using Docling's `do_picture_description=True` to get AI-generated captions, which would also improve LLM filtering accuracy.
- **No page-level chunk matching**: chunks don't carry page numbers, so we can't filter images by "same page as retrieved chunk." All images from a retrieved document are candidates for the LLM filter.

## Verification Steps

1. Upload a PDF with images, wait for ingestion to complete
2. Ask a question related to specific images in the document
3. Confirm: only relevant image thumbnails appear below the assistant response in a "Document images" gallery
4. Click a thumbnail — lightbox opens with larger view, close with X/Escape/backdrop
5. Reload the page, navigate back to the thread — images still appear from persisted attachments
6. Check browser Network tab: image requests include Authorization header and return 200
