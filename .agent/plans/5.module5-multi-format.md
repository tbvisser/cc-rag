# Module 5: Multi-Format Support

## Complexity: ⚠️ Medium

---

## PRD Requirement

> **Build:** PDF/DOCX/HTML/Markdown via docling, cascade deletes
> **Learn:** Document parsing challenges, format considerations

## Status: ✅ Complete

All tasks implemented and validated.

---

## Tasks

### 5.1 Docling Integration — Singleton DocumentConverter
- [x] `backend/app/services/ingestion_service.py`
  - Replaced per-file `DocumentConverter()` with a singleton (`_get_converter()`)
  - Models (OCR, layout, table structure) loaded once, reused across all requests
  - Pipeline configured with: `do_table_structure=True`, `do_ocr=True`
  - Allowed formats: PDF, DOCX, HTML, MD
  - PDF uses `PdfFormatOption` with `PdfPipelineOptions` for explicit pipeline config
  - Temp file approach (Windows-safe: `delete=False` + `os.unlink` in finally block)
  - Exports to markdown via `result.document.export_to_markdown()`

**Validation:** First upload takes ~10s (model init), subsequent uploads reuse loaded models. PDF with 77K chars extracted in 124s (3.5MB doc with OCR).

### 5.2 Supported MIME Types
- [x] `DOCLING_TYPES` maps MIME types to `(InputFormat, suffix)` tuples:
  - `application/pdf` → PDF
  - `application/vnd.openxmlformats-officedocument.wordprocessingml.document` → DOCX
  - `text/html` → HTML
  - `text/markdown` → MD
- [x] Non-docling types still handled: `application/json` (parsed+pretty-printed), `text/plain` / `text/csv` (raw decode)

### 5.3 Backend Route Updates
- [x] `backend/app/api/routes/documents.py` — `ALLOWED_TYPES` includes PDF, DOCX, HTML alongside existing TXT, MD, CSV, JSON

### 5.4 Storage Bucket MIME Config
- [x] `backend/app/services/storage_service.py` — `allowed_mime_types` includes DOCX and HTML
- [x] PUT to update existing bucket config when bucket already exists (picks up new MIME types)
- [x] `delete_file` handles 400+404 responses gracefully

### 5.5 Frontend Upload Support
- [x] `frontend/src/components/documents/DocumentUpload.tsx`
  - `ACCEPTED_TYPES` includes DOCX and HTML MIME types
  - `accept` attribute: `.txt,.md,.csv,.pdf,.json,.docx,.html,.htm`
  - Alert message lists all supported extensions
  - Description text shows all formats

### 5.6 Cascade Deletes
- [x] `supabase/migrations/002_byo_retrieval.sql` — chunks table has `REFERENCES documents(id) ON DELETE CASCADE`
- [x] `backend/app/api/routes/documents.py` — delete route calls `storage.delete_file()` then `supabase.delete_document()`, chunks auto-deleted by CASCADE
- [x] No explicit `delete_chunks_by_document()` call needed

**Validation:** Deleting a document removes its chunks automatically via database CASCADE.

### 5.7 Supabase Service Fixes
- [x] `backend/app/services/supabase_service.py` — removed `"updated_at": "now()"` from PATCH calls; DB BEFORE UPDATE trigger handles it

---

## Key Architecture Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Text extraction library | Docling | Handles PDF, DOCX, HTML, MD with OCR, table structure, layout detection |
| Converter lifetime | Singleton | ML models loaded once (~10s), reused across all requests |
| Export format | Markdown | Preserves document structure (headers, tables, lists) for better chunking/RAG |
| OCR engine | RapidOCR with torch | Auto-selected by docling; handles image-heavy PDFs |
| Temp file strategy | `delete=False` + `os.unlink` | Windows compatibility (can't delete open files) |

## Known Characteristics
- First docling call downloads OCR models (~40MB) and layout models from HuggingFace — one-time cost
- Large PDFs (3.5MB, 40+ pages) take ~2 min on CPU — this is expected for OCR + layout detection
- Some image-only pages produce "RapidOCR returned empty result!" warnings — this is normal for diagrams without text
- Server restart required after `pip install` due to WatchFiles reloader conflicts
