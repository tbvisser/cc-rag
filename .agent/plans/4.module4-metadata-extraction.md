# Module 4: Metadata Extraction

## Complexity: ⚠️ Medium

---

## PRD Requirement

> **Build:** LLM extracts structured metadata, filter retrieval by metadata
> **Learn:** Structured extraction, schema design, metadata-enhanced retrieval

## Status: ✅ Complete

All tasks implemented and validated.

---

## Tasks

### 4.1 Metadata Pydantic Model
- [x] `backend/app/models/metadata.py` — `ExtractedMetadata` with fields: title, summary, topics, document_type, language, key_entities

**Validation:** Model validates LLM output and provides typed access.

### 4.2 LLM-Based Metadata Extraction Service
- [x] `backend/app/services/metadata_extraction_service.py`
  - System prompt instructs LLM to return structured JSON with specific fields
  - Truncates long documents (first 4000 + last 4000 chars) to fit context window
  - Strips markdown code fences from LLM response before parsing
  - Graceful fallback on any failure (returns `ExtractedMetadata` with filename as title, empty topics)
  - Uses the same `LLMService.chat_completion()` as chat (non-streaming, sync)

**Validation:** `extract_metadata(text, filename)` returns valid `ExtractedMetadata` for any input.

### 4.3 Database Schema
- [x] `supabase/migrations/004_metadata_extraction.sql`
  - Adds `metadata JSONB DEFAULT '{}'` column to documents table
  - GIN indexes on `documents.metadata` and `chunks.metadata` for containment queries
  - Updated `search_chunks` function accepts optional `filter_metadata jsonb` parameter

**Validation:** `c.metadata @> filter_metadata` enables metadata-filtered vector search.

### 4.4 Metadata Saved During Ingestion
- [x] `backend/app/services/ingestion_service.py` — calls `extract_metadata()` after text extraction, saves via `update_document_metadata()`
- [x] `backend/app/services/supabase_service.py` — `update_document_metadata()` PATCHes the `metadata` JSONB column
- [x] Chunk-level metadata also stored: `document_type`, `topics`, `language` written to each chunk record

**Validation:** After ingestion, document row has rich metadata JSON; each chunk has type/topic/language metadata.

### 4.5 Metadata-Enhanced Retrieval
- [x] `backend/app/services/retrieval_service.py` — `retrieve()` accepts `metadata_filter` dict, passed through to `search_chunks` RPC
- [x] `backend/app/services/supabase_service.py` — `search_chunks()` passes `filter_metadata` to the Postgres RPC function

**Validation:** Retrieval can be filtered by metadata (e.g., `{"document_type": "manual"}`).

### 4.6 Frontend Metadata Display
- [x] `frontend/src/hooks/useDocuments.ts` — `Document` type includes `metadata` with title, summary, topics, document_type, language, key_entities
- [x] `frontend/src/components/documents/DocumentList.tsx`
  - Shows summary text when `status === 'completed'` and `metadata.summary` exists
  - Shows document_type as a blue badge
  - Shows first 3 topics as grey pills

**Validation:** Completed documents display metadata summary, type badge, and topic pills in the document list.
