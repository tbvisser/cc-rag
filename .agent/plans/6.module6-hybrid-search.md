# Module 6: Hybrid Search & Reranking

## Complexity: ⚠️ Medium

## Status: ✅ Complete

---

## Summary

Added keyword search (Postgres FTS), combined with vector search via Reciprocal Rank Fusion (RRF), and optional Cohere cross-encoder reranking.

## Files Changed

| Action | File |
|--------|------|
| Create | `supabase/migrations/005_hybrid_search.sql` |
| Create | `backend/app/services/reranking_service.py` |
| Modify | `backend/app/config.py` |
| Modify | `backend/app/services/supabase_service.py` |
| Modify | `backend/app/services/retrieval_service.py` |
| Modify | `backend/app/api/routes/settings.py` |
| Modify | `frontend/src/pages/Settings.tsx` |
| Modify | `PROGRESS.md` |

## Tasks Completed

1. **SQL Migration** — `GENERATED ALWAYS AS ... STORED` tsvector column on `chunks`, GIN index, `search_chunks_keyword()` RPC function
2. **Config** — `search_mode`, `hybrid_alpha`, `rrf_k`, `hybrid_candidate_limit`, `rerank_enabled`, `rerank_api_key`, `rerank_model`, `rerank_top_n`
3. **Supabase Service** — `search_chunks_keyword()` method mirroring vector search pattern
4. **Reranking Service** — Cohere Rerank v2 via raw httpx, graceful fallback if no key
5. **Retrieval Service** — Hybrid search + RRF fusion + optional reranking pipeline
6. **Settings API + UI** — RetrievalConfig model, search mode dropdown, alpha slider, reranking toggle

## Key Decisions

- tsvector: `GENERATED ALWAYS AS ... STORED` — auto-backfills, no ingestion changes
- Keyword ranking: `ts_rank_cd` + `websearch_to_tsquery` (BM25-like, supports phrases)
- Fusion: RRF in Python (not SQL) — easier to debug/tune
- Reranking: Cohere API via raw httpx — no new SDK dependency
- Score field: reuse `similarity` key for all modes — no downstream changes needed
